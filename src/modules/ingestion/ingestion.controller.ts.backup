import { Controller, Post, Body, Get, HttpStatus, HttpException } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse, ApiBody } from '@nestjs/swagger';
import { IngestionService } from './ingestion.service';
import { IngestNfceDto, IngestAutoDto, HealthCheckDto } from './dto/ingest.dto';

@ApiTags('ingestion')
@Controller('api/v1/ingest')
export class IngestionController {
  constructor(private readonly ingestionService: IngestionService) {}

  @Post('nfce')
  @ApiOperation({ summary: 'Ingerir NFC-e por chave de acesso' })
  @ApiBody({ type: IngestNfceDto })
  @ApiResponse({ status: 201, description: 'NFC-e processada com sucesso' })
  @ApiResponse({ status: 400, description: 'Dados inválidos' })
  async ingestNfce(@Body() body: IngestNfceDto) {
    try {
      return await this.ingestionService.processarNFCe(body.chaveAcesso, body.timeout);
    } catch (error) {
      throw new HttpException(
        error.message || 'Erro ao processar NFC-e',
        error.status || HttpStatus.INTERNAL_SERVER_ERROR,
      );
    }
  }

  @Post('auto')
  @ApiOperation({ summary: 'Ingestão automática por QR Code' })
  @ApiBody({ type: IngestAutoDto })
  @ApiResponse({ status: 201, description: 'Documento processado com sucesso' })
  @ApiResponse({ status: 400, description: 'QR Code inválido' })
  async ingestAuto(@Body() body: IngestAutoDto) {
    try {
      return await this.ingestionService.processarAutomaticamente(body.qrCode, body.timeout);
    } catch (error) {
      throw new HttpException(
        error.message || 'Erro ao processar documento',
        error.status || HttpStatus.INTERNAL_SERVER_ERROR,
      );
    }
  }

  @Get('health')
  @ApiOperation({ summary: 'Verificar saúde do sistema de ingestão' })
  @ApiResponse({ status: 200, description: 'Sistema saudável' })
  async healthCheck() {
    try {
      return {
        status: 'healthy',
        timestamp: new Date().toISOString(),
        services: {
          mongodb: await this.ingestionService.verificarConexaoMongoDB(),
          infosimples: await this.ingestionService.verificarConexaoInfosimples(),
          storage: await this.ingestionService.verificarStorage(),
        },
        version: process.env.npm_package_version || '1.0.0',
      };
    } catch (error) {
      throw new HttpException(
        { status: 'unhealthy', error: error.message },
        HttpStatus.SERVICE_UNAVAILABLE,
      );
    }
  }
}